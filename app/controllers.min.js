/* angular-qpme 2017-05-21 */app.controller("activateController",function($scope,$location,$routeParams,$http,$rootScope,appConfig,$cookieStore){var uid=$routeParams.uid;console.log(uid),$scope.activate={},$scope.activate.uid=uid,$scope.activate.password="",$scope.submit_disabled=!0,$scope.$watch("activate",function(){console.log("changed"),$scope.activate.password.length<7&&$scope.activate.password.length>0?($scope.login_error=!0,$scope.error_txt="Password is too short (Minimum 8).",$scope.submit_disabled=!0):$scope.activate.password!=$scope.activate.new_password&&$scope.activate.password.length>7?($scope.login_error=!0,$scope.error_txt="Passwords do not match.",$scope.submit_disabled=!0):($scope.login_error=!1,$scope.submit_disabled=!1)},!0),$scope.passwordSet=function(){if($scope.submit_disabled!==!1)$scope.activate.login_error=!0;else{var url="https://"+appConfig.domain+"/user/password";$http.put(url,$scope.activate,config).success(function(data,status,headers,config){console.log(data)}).error(function(data,status,header,config){console.log(data)});var url2="https://"+appConfig.domain+"/user/activate";$http.put(url2,$scope.activate,config).success(function(data,status,headers,config){console.log(data)}).error(function(data,status,header,config){console.log(data)})["finally"](function(){$cookieStore.remove("user"),$location.path("/")})}}}),app.controller("addResidentController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){$scope.resident={},$scope.resident.level=3,$scope.resident.user_type="resident",$scope.resident.password="123456",$scope.resident.company_id="t37rjido2qcxpnihkb3w",$scope.resident.active=0,$scope.add_resident=function(){$http({method:"POST",url:"https://"+appConfig.domain+"/user",data:$scope.resident,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data),data.error?$scope.error_text=data.msg:$location.path("/residents")}).error(function(data,status,headers,config){console.log(data)})}}),app.controller("basicController",function($scope,$log){this.product=gem,this.items=item,$scope.$log=$log,$scope.log_message="This is a logged message",$scope.info_message="This is an info message",$scope.warn_message="This is a warning message",$scope.error_message="This is an error form message",$log.log($scope.log_message),$log.info($scope.info_message),$log.warn($scope.warn_message),$log.error($scope.error_message)}),app.controller("commentsController",function(){this.pic=20,this.comment={},this.comm=function(block){console.log(block.comment),block.comments.push(block.comment),console.log(block.comments),block.comment={}},this.comments=[{name:"Eric Cavazos",rating:5,text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Provident eos dolorem, earum quae quaerat cumque ipsa ipsam voluptatum aperiam, officiis deleniti. Odit amet qui facilis sint architecto debitis modi delectus."},{name:"James Rhodes",rating:3,text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Provident eos dolorem, earum quae quaerat cumque ipsa ipsam voluptatum aperiam, officiis deleniti. Odit amet qui facilis sint architecto debitis modi delectus."},{name:"Chris Banson",rating:1,text:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Provident eos dolorem, earum quae quaerat cumque ipsa ipsam voluptatum aperiam, officiis deleniti. Odit amet qui facilis sint architecto debitis modi delectus."}]}),app.controller("currentOccupancyController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.currentPermits=function(){var unix_time=Math.round((new Date).getTime()/1e3);console.log(unix_time),console.log(unix_time-14400),unix_time-=14400;var t=new Date(1e3*unix_time);$scope.current_unit_time=t,$http({method:"GET",url:"https://"+appConfig.domain+"/occupancy",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data_parked,status,headers,config){console.log(data_parked),$scope.loaded=!0,data_parked.length<1&&($scope.no_permits=!0);var columns=[{sTitle:"Entry Time",mData:"InTime"},{sTitle:"LPN",mData:"LPN"},{sTitle:"Exit Time",mData:"OutTime"},{sTitle:"Lot Id",mData:"LotId"},{sTitle:"Color",mData:"Color"},{sTitle:"Event Id",mData:"EventId"}];$("#current-permits-table").dataTable({data:data_parked,columns:columns})}).error(function(data,status,headers,config){console.log(data)})},$scope.currentPermits()}),app.controller("currentPermitsController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.currentPermits=function(){var unix_time=Math.round((new Date).getTime()/1e3);console.log(unix_time),console.log(unix_time-14400),unix_time-=14400;var t=new Date(1e3*unix_time);$scope.current_unit_time=t,console.log($scope.user.user_type),"master"==$scope.user.user_type?$http({method:"GET",url:"https://"+appConfig.domain+"/permit/current/"+unix_time,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data_parked,status,headers,config){console.log(data_parked.data),data_parked.data.length<1&&($scope.no_permits=!0);var columns=[{sTitle:"Create Time",mData:"CreateTime"},{sTitle:"Begin Time",sClass:"BeginTime"},{sTitle:"Expiry Time",sClass:"ExpiryTime"},{sTitle:"Suit Id",mData:"SuiteId"},{sTitle:"Permit Class",mData:"PermitClass"},{sTitle:"First Name",mData:"FirstName"},{sTitle:"Last Name",mData:"LastName"},{sTitle:"Phone",mData:"Phone"},{sTitle:"Email",mData:"Email"},{sTitle:"LPN",mData:"LPN"},{sTitle:"Make",mData:"Make"},{sTitle:"Model",mData:"Model"},{sTitle:"Color",mData:"Color"},{sTitle:"Permit Tag",mData:"PermitTag"}];$("#current-permits-table").dataTable({data:data_parked.data,columns:columns,columnDefs:[{targets:1,data:function(row,type,val,meta){var x=row.BeginTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.BeginTime;return y=y.substring(0,10),y=y+" "+x}},{targets:2,data:function(row,type,val,meta){var x=row.ExpiryTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.ExpiryTime;return y=y.substring(0,10),y=y+" "+x}},{targets:3,type:"numeric-comma"}]})}).error(function(data,status,headers,config){console.log(data)}):$http({method:"GET",url:"https://"+appConfig.domain+"/permit/resident/current/"+$scope.user.uid+"/"+unix_time,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data_parked,status,headers,config){console.log(data_parked.data),data_parked.data.length<1&&($scope.no_permits=!0);var columns=[{sTitle:"Create Time",mData:"CreateTime"},{sTitle:"Begin Time",sClass:"BeginTime"},{sTitle:"Expiry Time",sClass:"ExpiryTime"},{sTitle:"Suit Id",mData:"SuiteId"},{sTitle:"Permit Class",mData:"PermitClass"},{sTitle:"First Name",mData:"FirstName"},{sTitle:"Last Name",mData:"LastName"},{sTitle:"Phone",mData:"Phone"},{sTitle:"Email",mData:"Email"},{sTitle:"LPN",mData:"LPN"},{sTitle:"Make",mData:"Make"},{sTitle:"Model",mData:"Model"},{sTitle:"Color",mData:"Color"},{sTitle:"Permit Tag",mData:"PermitTag"}];$("#current-permits-table").dataTable({data:data_parked.data,columns:columns,columnDefs:[{targets:1,data:function(row,type,val,meta){var x=row.BeginTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.BeginTime;return y=y.substring(0,10),y=y+" "+x}},{targets:2,data:function(row,type,val,meta){var x=row.ExpiryTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.ExpiryTime;return y=y.substring(0,10),y=y+" "+x}},{targets:3,type:"numeric-comma"}]})}).error(function(data,status,headers,config){console.log(data)})},$scope.currentPermits(),jQuery.extend(jQuery.fn.dataTableExt.oSort,{"numeric-comma-pre":function(a){var x="-"==a?0:a.replace(/,/,".");return parseFloat(x)},"numeric-comma-asc":function(a,b){return b>a?-1:a>b?1:0},"numeric-comma-desc":function(a,b){return b>a?1:a>b?-1:0}})}),app.controller("dashboardController",function($scope,$location,$http,appConfig,$rootScope){function daysInMonth(month,year){return new Date(year,month,0).getDate()}function next_day(i){var today=new Date,dd=today.getDate(),mm=today.getMonth()+1,yyyy=today.getFullYear();if(10>dd&&(dd="0"+dd),10>mm&&(mm="0"+mm),dd=Number(dd-i),1>dd){var dx=-1*dd;mm=today.getMonth(),dd=daysInMonth(mm,yyyy),dd=Number(dd-dx)}today=mm+"/"+dd+"/"+yyyy;var unix_date=new Date(today.split("/").join("-")).getTime()/1e3;days_data.push(unix_date),days.push(today),get_data(unix_date)}function get_data(unix_date){console.log(unix_date),$http({method:"GET",url:"https://"+appConfig.domain+"/permit/day/"+unix_date+"/"+$scope.user.uid,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status,headers,config){var permits=data.length;chart_data.push(permits)}).error(function(data,status,headers,config){console.log(data)})["finally"](function(data){6==days_data.length?($scope.loaded=!0,build_chart(chart_data)):(count++,next_day(count))})}function build_chart(chart_data){var data={labels:days,datasets:[{label:"Permits",fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:chart_data}]},options={showScale:!0,scaleOverride:!1,maintainAspectRatio:!0,responsive:!0},ctx=document.getElementById("myChart").getContext("2d");new Chart(ctx).Bar(data,options)}$scope.domain=appConfig.domain,$scope.user=$rootScope.user.info,console.log($scope.user);var days=[],days_data=[],chart_data=[],count=0;$scope.loaded=!1,next_day(0),$scope.currentPermits=function(){var unix_time=Math.round((new Date).getTime()/1e3);console.log(unix_time),$http({method:"GET",url:"https://"+appConfig.domain+"/permit/current/"+$scope.user.uid+"/"+unix_time,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data_parked,status,headers,config){$scope.permit_number=data_parked.data.length,console.log(data_parked.data)}).error(function(data,status,headers,config){console.log(data)})},$scope.currentPermits()}),app.controller("editResidentController",function($scope,$routeParams,$location,$http,appConfig,$rootScope,$cookieStore,locationService){$scope.resident_id=$routeParams.id,console.log($scope.resident_id),$scope.resident={},$scope.get_resident=function(){$http({method:"GET",url:"https://"+appConfig.domain+"/user/"+$scope.resident_id,data:$scope.resident,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data),$scope.resident.first_name=data.first_name,$scope.resident.last_name=data.last_name,$scope.resident.user=data.user,$scope.resident.phone=data.phone,$scope.resident.email=data.email,$scope.resident.suite_id=data.suite_id,$scope.resident.parking_spot=data.parking_spot,$scope.resident.permits_allowed=Number(data.permits_allowed),$scope.resident.user_type=data.user_type}).error(function(data,status,headers,config){console.log(data)})},$scope.get_resident(),$scope.edit_resident=function(){$http({method:"PUT",url:"https://"+appConfig.domain+"/user/"+$scope.resident_id,data:$scope.resident,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data)}).error(function(data,status,headers,config){console.log(data)})["finally"](function(){$location.path("/residents")})}}),app.controller("loginController",function($scope,$location,$http,$rootScope,appConfig,$cookieStore){$scope.login={},$rootScope.user={},$scope.password_email=!1,$scope.auth=function(login){console.log(login);var auth=Base64.encode(login.username+":"+login.password);$http({method:"GET",url:"https://"+appConfig.domain+"/login",headers:{"Content-Type":"application/json",Authorization:"Basic "+auth}}).success(function(data,status,headers,config){console.log(data),$scope.login_error=!1;var username=login.username;$rootScope.user.basicAuth=auth,$rootScope.user.info=data[0],$rootScope.user.login=username,$cookieStore.put("user",$rootScope.user),console.log($rootScope.user),"resident"==$rootScope.user.info.user_type?$location.path("/visitor-permit"):$location.path("/dashboard"),$("#top-nav").show()}).error(function(data,status,headers,config){$scope.login_error=!0})},$scope.forgot_password=function(){var url="https://"+appConfig.domain+"/user/password_reset";$http.post(url,$scope.login_forgot,config).success(function(data,status,headers,config){console.log(data),data.user===!1?$scope.user_error=!0:($scope.user_error=!1,$scope.password_email=!0)}).error(function(data,status,header,config){console.log(data)})},$scope.reload=function(){location.reload()}}),app.controller("lotConfigController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){$scope.lot_list=[],$scope.lot_maxx=0,$scope.permit={},$scope.lot_hold="",$scope.lots=function(){$http({method:"GET",url:"https://"+appConfig.domain+"/property/jtyhp3dwgs3j6v8cl2zl/lots",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(lot_data,status,headers,config){console.log(lot_data),$scope.lot_list=lot_data}).error(function(data,status,headers,config){console.log(data)})},$scope.lot_max_permit=function(lot_id){console.log(lot_id),$scope.lot_hold=lot_id,$http({method:"GET",url:"https://"+appConfig.domain+"/property/jtyhp3dwgs3j6v8cl2zl/lots/"+lot_id,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(lot_data,status,headers,config){console.log(lot_data),$scope.lot_max=lot_data[0].MaxPermits,console.log($scope.lot_max),$scope.permit={max:lot_data[0].MaxPermits}}).error(function(data,status,headers,config){console.log(data)})},$scope.lots(),$scope.max_permits=function(){console.log("test"),console.log($scope.permit),$scope.permit.max=$scope.lot_max,console.log($scope.permit),$http({method:"PUT",url:"https://"+appConfig.domain+"/lot/"+$scope.lot_hold+"/max_permits",data:$scope.permit,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data)}).error(function(data,status,headers,config){console.log(data)})}}),app.controller("mainController",function($scope,$rootScope,$location){$scope.message="This is a homepage message",this.booger=function(){alert('Uses the "this"')},$scope.booger=function(){alert('Uses the "$scope"'),$(".boogerTitle").html("Changed by Jquery")},$scope.pin="",$scope.addNumber=function(num){$scope.pin=$scope.pin+num.toString()},$scope.submitPin=function(){$location.path("/pay")},document.getElementById("PINbox").addEventListener("input",function(e){e.target.value=e.target.value.replace(/[^\dA-Z]/g,"").replace(/(.{4})/g,"$1 ").trim()}),$("#PINbox").focus()}),app.controller("addResidentController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){$scope.resident={},$scope.resident.level=3,$scope.resident.user_type="resident",$scope.resident.password="123456",$scope.resident.company_id="t37rjido2qcxpnihkb3w",$scope.resident.active=0,$scope.add_resident=function(){$http({method:"POST",url:"https://"+appConfig.domain+"/user",data:$scope.resident,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data),data.error?$scope.error_text=data.msg:$location.path("/residents")}).error(function(data,status,headers,config){console.log(data)})}}),app.controller("navController",function($scope,$location,$rootScope,$cookieStore){$scope.user=$rootScope.user.info,"master"!=$scope.user.user_type&&"admin"!=$scope.user.user_type||($scope.admin_show=!0),$scope.logout=function(){$cookieStore.remove("user"),$location.path("/"),window.location.reload(!0)},$scope.reports=function(){$(".sub-reports").toggleClass("active-list"),$(".nav-expand").toggleClass("chevron-down"),$(".reports-link").toggleClass("down")}}),app.controller("payController",function($scope,$rootScope,$location){$scope.paid=!1,$scope.payAction=function(){$scope.paid=!0},$scope.goHome=function(){$location.path("/")}}),app.controller("residentOccupancyController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.currentPermits=function(){var unix_time=Math.round((new Date).getTime()/1e3);console.log(unix_time),console.log(unix_time-14400),unix_time-=14400;var t=new Date(1e3*unix_time);$scope.current_unit_time=t,$http({method:"GET",url:"https://"+appConfig.domain+"/occupancy/resident",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data_parked,status,headers,config){console.log(data_parked),data_parked.length<1&&($scope.no_permits=!0);var columns=[{sTitle:"Entry Time",mData:"InTime"},{sTitle:"LPN",mData:"LPN"},{sTitle:"Exit Time",mData:"OutTime"},{sTitle:"Lot Id",mData:"LotId"},{sTitle:"Color",mData:"Color"},{sTitle:"Event Id",mData:"EventId"}];$("#current-permits-table").dataTable({data:data_parked.data,columns:columns,columnDefs:[{targets:1,data:function(row,type,val,meta){var x=row.BeginTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.BeginTime;return y=y.substring(0,10),y=y+" "+x,console.log(y),y}},{targets:2,data:function(row,type,val,meta){var x=row.ExpiryTime;x=x.slice(-8),x=Number(x.substring(0,2)),x-=4,x="0"+x+":00:00";var y=row.ExpiryTime;return y=y.substring(0,10),y=y+" "+x,console.log(y),y}},{targets:3,type:"numeric-comma"}]})}).error(function(data,status,headers,config){console.log(data)})},$scope.currentPermits(),jQuery.extend(jQuery.fn.dataTableExt.oSort,{"numeric-comma-pre":function(a){var x="-"==a?0:a.replace(/,/,".");return parseFloat(x)},"numeric-comma-asc":function(a,b){return b>a?-1:a>b?1:0},"numeric-comma-desc":function(a,b){return b>a?1:a>b?-1:0}})}),app.controller("residentPermitController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){function createPermit(data,n){$http({method:"POST",url:"https://"+appConfig.domain+"/permit",data:data,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data)}).error(function(data,status,headers,config){console.log(data)})["finally"](function(){n==$scope.visitorPermit.data.selected_lots.length-1&&$location.path("/current-permits")})}function permit_custom_enable(){""!==$("#datepicker").val()&&""!==$("#datepicker2").val()&&""!==$("#timepicker").val()&&""!==$("#timepicker2").val()?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0}console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.visitorPermit={},$scope.visitorPermit.data={},$scope.visitorPermit.views=["visitor","vehicle","time"],$scope.visitorPermit.vehicleSearch=!1,$scope.visitorPermit.data.user=0,$scope.visitorPermit.lots=[{id:"b06memz7ms39wo2tnyl5",name:"Main Lot - Visitor"},{id:"xcic6y0b0a04oygof2va",name:"P1"},{id:"q09l3yp0tspr0u3v2r7x",name:"Level 2"}],$scope.visitorPermit.data.lot=0,$scope.resident_check=[],$scope.visitorPermit.data.selected_lots=[],$scope.pushLot=function(lot){var index=$scope.visitorPermit.data.selected_lots.indexOf(lot);index>-1?$scope.visitorPermit.data.selected_lots.splice(index,1):$scope.visitorPermit.data.selected_lots.push(lot),console.log($scope.visitorPermit.data.selected_lots)},$scope.residents=function(){$http({method:"GET",url:"https://"+appConfig.domain+"/residents",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(resident_data,status,headers,config){for(console.log(resident_data),z=0;z<resident_data.length;z++)$scope.resident_check.push(resident_data[z].user);$("#residents").autocomplete({source:function(request,response){response($.map(resident_data,function(value,key){return console.log(value),console.log(key),{label:value.user,value:value.user,uid:value.uid}}))},select:function(event,ui){console.log(event),console.log(ui),$http({method:"GET",url:"https://"+appConfig.domain+"/user/"+ui.item.uid,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(info,status,headers,config){console.log(info),$scope.resident=info,$scope.visitorPermit.data.first_name=$scope.resident.first_name,$scope.visitorPermit.data.last_name=$scope.resident.last_name,$scope.visitorPermit.data.email=$scope.resident.email,$scope.visitorPermit.data.phone=$scope.resident.phone,$scope.visitorPermit.data.user=$scope.resident.user,$scope.visitorPermit.data.vistor_suite=$scope.resident.suite_id}).error(function(data,status,headers,config){console.log(data)})}}),$scope.residents=resident_data}).error(function(data,status,headers,config){console.log(data)})},$scope.residents();var i=0;$scope.visitorPermit.window=$scope.visitorPermit.views[i],$scope.visitorPermit.visitorNext=function(){console.log($scope.visitorPermit.data),console.log($scope.visitorPermit.window),$scope.visitorPermit.next=!0,i++,$scope.visitorPermit.window=$scope.visitorPermit.views[i],"time"==$scope.visitorPermit.window&&$scope.custom_click(),console.log($scope.visitorPermit.window)},$scope.visitorPermit.visitorPrevious=function(){$scope.visitorPermit.next=!1,i--,$scope.visitorPermit.window=$scope.visitorPermit.views[i]},$scope.visitorPermit.next=!0,$scope.$watch("visitorPermit.data",function(){console.log($scope.visitorPermit.window),"visitor"==$scope.visitorPermit.window&&(0!==$scope.resident&&$scope.visitorPermit.data.vistor_suite&&$scope.visitorPermit.data.first_name&&$scope.visitorPermit.data.last_name&&$scope.visitorPermit.data.phone&&$scope.visitorPermit.data.email&&$scope.visitorPermit.data.selected_lots.length>0?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0),"vehicle"==$scope.visitorPermit.window&&($scope.visitorPermit.data.vehicle_license&&$scope.visitorPermit.data.vehicle_make&&$scope.visitorPermit.data.vehicle_model&&$scope.visitorPermit.data.vehicle_color?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0)},!0),$scope.custom_click=function(){var today=new Date,dd=today.getDate(),mm=today.getMonth()+1,yyyy=today.getFullYear();10>dd&&(dd="0"+dd),10>mm&&(mm="0"+mm),today=mm+"/"+dd+"/"+yyyy,$scope.visitorPermit.data.permit_start_date=today,$scope.visitorPermit.data.permit_start_time="8:00am",$scope.visitorPermit.data.permit_end_date=today,$scope.visitorPermit.data.permit_end_time="8:00pm",$scope.visitorPermit.next=!1},Date.prototype.yyyymmdd=function(){var yyyy=this.getFullYear().toString(),mm=(this.getMonth()+1).toString(),dd=this.getDate().toString();return yyyy+"-"+(mm[1]?mm:"0"+mm[0])+"-"+(dd[1]?dd:"0"+dd[0])},Date.prototype.addDays=function(days){var dat=new Date(this.valueOf());return dat.setDate(dat.getDate()+days),dat},$scope.visitorPermit.visitorCreate=function(){$scope.visitorPermit.next=!0,$http({method:"GET",url:"https://"+appConfig.domain+"/timezone/jtyhp3dwgs3j6v8cl2zl",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(datax,status,headers,config){console.log(datax[0].UTCOffset);var offset=datax[0].UTCOffset;begin_date=convertDate($scope.visitorPermit.data.permit_start_date),end_date=convertDate($scope.visitorPermit.data.permit_end_date);var start_hour=0+-1*Number(offset);10>start_hour&&(start_hour="0"+start_hour.toString());var end_hour=24+-1*Number(offset);if(end_hour>24){var x=new Date(end_date);x=x.addDays(2),x=x.yyyymmdd(),console.log("value:"+x),end_date=x,end_hour=0+-1*Number(offset),10>end_hour&&(end_hour="0"+end_hour.toString())}if(begin_date>end_date)$scope.date_error=!0;else for($scope.date_error=!1,console.log(begin_date),console.log(end_date),n=0;n<$scope.visitorPermit.data.selected_lots.length;n++){var data={creator_uid:$scope.user.uid,company_id:$scope.user.company_id,property_id:"jtyhp3dwgs3j6v8cl2zl",lot_id:$scope.visitorPermit.data.selected_lots[n],suite_number:$scope.visitorPermit.data.vistor_suite,first_name:$scope.visitorPermit.data.first_name,last_name:$scope.visitorPermit.data.last_name,phone:$scope.visitorPermit.data.phone,email:$scope.visitorPermit.data.email,license_number:$scope.visitorPermit.data.vehicle_license,car_make:$scope.visitorPermit.data.vehicle_make,car_model:$scope.visitorPermit.data.vehicle_model,car_color:$scope.visitorPermit.data.vehicle_color,begin_time:begin_date+" "+start_hour+":00:00",expire_time:end_date+" "+end_hour+":00:00",role:"resident",permit_class:"Resident"};console.log(data),createPermit(data,n)}}).error(function(data,status,headers,config){console.log(data)})};var convertDate=function(usDate){var dateParts=usDate.split(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);return dateParts[3]+"-"+dateParts[1]+"-"+dateParts[2]};$("#datepicker").datepicker({onSelect:function(dateText){console.log(dateText+" "+this.value);var datestr=dateText,start=new Date(datestr.split("/").join("-")).getTime();console.log(start),$scope.$apply(function(){$scope.visitorPermit.data.permit_start_date=dateText}),permit_custom_enable()}}),$("#datepicker2").datepicker({onSelect:function(dateText){console.log(dateText+" "+this.value);var end=convertDate(dateText);console.log(end),$scope.$apply(function(){$scope.visitorPermit.data.permit_end_date=dateText}),permit_custom_enable()}})}),app.controller("residentsController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){console.log($rootScope.user),$scope.user=$rootScope.user.info;var tap=0;$scope.residents=function(){$http({method:"GET",url:"https://"+appConfig.domain+"/residents",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(resident_data,status,headers,config){console.log(resident_data),resident_data.length<1&&($scope.no_permits=!0);var columns=[{sTitle:"Suite Id",mData:"suite_id"},{sTitle:"Username",mData:"user"},{sTitle:"First Name",mData:"first_name"},{sTitle:"Last Name",mData:"last_name"},{sTitle:"Email",mData:"email"},{sTitle:"Phone",mData:"phone"},{sTitle:"Created Date",mData:"created"},{sTitle:"Active",mData:"active"},{sTitle:"Parking Spot",mData:"parking_spot",sClass:"parking_spot"},{sTitle:"Edit",sClass:"edit-resident"},{sTitle:"Remove",sClass:"remove-resident"}];$("#residents-table").dataTable({data:resident_data,columns:columns,columnDefs:[{targets:-1,data:function(row,type,val,meta){var user=row.uid;return'<button class="btn btn-danger btn-sm delete-resident" data-uid="'+user+'" ng-click="editResident('+user+');">Remove</button>'}},{targets:-2,data:function(row,type,val,meta){var user=row.uid;return'<button class="btn btn-success btn-sm edit-resident" data-uid="'+user+'" ng-click="editResident('+user+');">Edit</button>'}}],responsive:!0}),$("#content").on("click",".delete-resident",function(){var uid=$(this).data("uid");console.log(uid),$http({method:"DELETE",url:"https://"+appConfig.domain+"/user/remove/"+uid,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(resident_data,status,headers,config){console.log(resident_data),location.reload()}).error(function(data,status,headers,config){console.log(data)})}),$("#residents-table").on("click",".edit-resident",function(){var uid=$(this).data("uid");console.log(uid),tap++,1==tap?window.location="/#/edit-resident/"+uid:console.log("no redirect")})}).error(function(data,status,headers,config){console.log(data)})},$scope.residents(),$scope.editResident=function(x){console.log(x),alert("test")}}),app.controller("tabController",function(){this.tab=1,this.selectTab=function(setTab){this.tab=setTab},this.isSelected=function(checkTab){return this.tab===checkTab}}),app.controller("topNavController",function($scope,$location,$rootScope,$cookieStore){$scope.logout=function(){$cookieStore.remove("user"),$location.path("/"),window.location.reload(!0)},$scope.menu=function(){$("#wrapper").toggleClass("toggled"),$(".menu-open").toggleClass("closed")},"/"!==$location.path()&&"/activate"!==$location.path()||$("#top-nav").hide()}),app.controller("userProfileController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService){console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.reset={},$scope.reset.uid=$scope.user.uid,$scope.save_profile=function(){$http({method:"PUT",url:"https://"+appConfig.domain+"/user",data:$scope.user,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status,headers,config){console.log(data),$scope.user=data.data,$rootScope.user.info=data.data,$cookieStore.put("user",$rootScope.user),console.log($rootScope.user.info)}).error(function(data,status,header,config){console.log(data)})["finally"](function(){location.reload()})},$scope.passwordSet=function(){console.log($scope.activate);var url="https://"+appConfig.domain+"/user/password";$http.put(url,$scope.reset,config).success(function(data,status,headers,config){console.log(data)}).error(function(data,status,header,config){console.log(data)})["finally"](function(){$scope.password_input=!1;var auth=Base64.encode($scope.user.user+":"+$scope.reset.password);$http({method:"GET",url:"https://"+appConfig.domain+"/login",headers:{"Content-Type":"application/json",Authorization:"Basic "+auth}}).success(function(data,status,headers,config){console.log(data),$rootScope.user.basicAuth=auth,$cookieStore.put("user",$rootScope.user)}).error(function(data,status,headers,config){console.log(data)})})}}),app.controller("visitorPermitController",function($scope,$location,$http,appConfig,$rootScope,$cookieStore,locationService,notifications){function permit_custom_enable(){""!==$("#datepicker").val()&&""!==$("#datepicker2").val()&&""!==$("#timepicker").val()&&""!==$("#timepicker2").val()?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0}console.log($rootScope.user),$scope.user=$rootScope.user.info,$scope.visitorPermit={},$scope.visitorPermit.data={},$scope.visitorPermit.views=["visitor","vehicle","time"],$scope.visitorPermit.vehicleSearch=!1,$scope.loaded=!1,"resident"==$scope.user.user_type&&($scope.visitorPermit.data.vistor_suite=$scope.user.suite_id,$http({method:"GET",url:"https://"+appConfig.domain+"/permit/resident/"+$scope.user.suite_id,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status,headers,config){console.log(data),$scope.resident_permits=data}).error(function(data,status,headers,config){console.log(data)})),$scope.visitorPermit.data.phone="",$scope.visitorPermit.data.email="",$scope.visitorPermit.data.vehicle_model="",$scope.visitorPermit.status=!1;var date=new Date;$scope.visitorPermit.data.permit_start_date=date.getMonth()+1+"/"+date.getDate()+"/"+date.getFullYear(),$scope.visitorPermit.statusCheck=function(){var unix=Math.floor(Date.now()/1e3);$http({method:"GET",url:"https://"+appConfig.domain+"/permit/status/"+$scope.user.uid+"/"+unix,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status,headers,config){console.log(data),data.limit_error===!0?($scope.visitorPermit.limit_error=!0,$scope.loaded=!0):($scope.visitorPermit.limit_error=!1,$scope.loaded=!0)}).error(function(data,status,headers,config){console.log(data)})},$scope.visitorPermit.statusCheck();var i=0;$scope.visitorPermit.window=$scope.visitorPermit.views[i],$scope.visitorPermit.visitorNext=function(){if(console.log($scope.visitorPermit.data),$scope.visitorPermit.next=!0,"vehicle"==$scope.visitorPermit.window)if(console.log("ran resident permit check"),"resident"==$scope.user.user_type&&$scope.resident_permits.length>0)for(z=0;z<$scope.resident_permits.length;z++){
if(console.log("looped through resident lpns"),$scope.visitorPermit.data.vehicle_license==$scope.resident_permits[z].LPN)return console.log("INVALID LPN"),void($scope.lpn_invalid=!0);console.log(z,$scope.resident_permits.length),z==$scope.resident_permits.length-1&&(console.log("no issue - move forward"),$scope.lpn_invalid=!1,i++,$scope.visitorPermit.window=$scope.visitorPermit.views[i])}else i++,$scope.visitorPermit.window=$scope.visitorPermit.views[i];else i++,$scope.visitorPermit.window=$scope.visitorPermit.views[i]},$scope.visitorPermit.visitorPrevious=function(){$scope.visitorPermit.next=!1,i--,$scope.visitorPermit.window=$scope.visitorPermit.views[i]},$scope.visitorPermit.next=!0,$scope.$watch("visitorPermit.data",function(){"visitor"==$scope.visitorPermit.window&&($scope.visitorPermit.data.vistor_suite&&$scope.visitorPermit.data.first_name&&$scope.visitorPermit.data.last_name&&$scope.visitorPermit.data.phone?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0),"vehicle"==$scope.visitorPermit.window&&($scope.visitorPermit.data.vehicle_license&&$scope.visitorPermit.data.vehicle_make&&$scope.visitorPermit.data.vehicle_color?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0),"time"==$scope.visitorPermit.window&&("custom_permit"==$scope.visitorPermit.data.permit_type?($scope.visitorPermit.next=!1,$scope.visitorPermit.data.permit_start_date&&$scope.visitorPermit.data.permit_start_time&&$scope.visitorPermit.data.permit_end_date&&$scope.visitorPermit.data.permit_end_time?$scope.visitorPermit.next=!1:$scope.visitorPermit.next=!0):"extended_permit"==$scope.visitorPermit.data.permit_type?$scope.visitorPermit.next=!0:$scope.visitorPermit.next=!1)},!0),$scope.custom_click=function(){var today=new Date,dd=today.getDate(),mm=today.getMonth()+1,yyyy=today.getFullYear();10>dd&&(dd="0"+dd),10>mm&&(mm="0"+mm),today=mm+"/"+dd+"/"+yyyy,$scope.visitorPermit.data.permit_start_date=today,$scope.visitorPermit.data.permit_start_time="8:00am",$scope.visitorPermit.data.permit_end_date=today,$scope.visitorPermit.data.permit_end_time="8:00pm"},Date.prototype.yyyymmdd=function(days){var yyyy=this.getFullYear().toString(),mm=(this.getMonth()+1).toString(),dd=this.getDate().toString();return console.log(dd),yyyy+"-"+(mm[1]?mm:"0"+mm[0])+"-"+(dd[1]?dd:"0"+dd[0])},Date.prototype.addDays=function(days){var dat=new Date(this.valueOf());return dat.setDate(dat.getDate()+days),dat};var dat=new Date;console.log(dat);var xx=dat.addDays(1);console.log(xx);var z=xx.yyyymmdd();console.log(z),$scope.visitorPermit.visitorCreate=function(){$scope.visitorPermit.next=!0,$http({method:"GET",url:"https://"+appConfig.domain+"/timezone/jtyhp3dwgs3j6v8cl2zl",headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(datax,status,headers,config){console.log(datax[0].UTCOffset);var offset=-1*Number(datax[0].UTCOffset),d="",bd="",begin_time="",ed="",expire_time="",begin_hour=0,end_hour=0;if("custom_permit"==$scope.visitorPermit.data.permit_type)begin_time=convertDate($scope.visitorPermit.data.permit_start_date),end_time=convertDate($scope.visitorPermit.data.permit_end_date);else if("day_permit"==$scope.visitorPermit.data.permit_type){d=new Date,bd=d.yyyymmdd(),bd=convertDate($scope.visitorPermit.data.permit_start_date),console.log(offset),begin_hour=7+offset,begin_hour=10>begin_hour?"0"+begin_hour.toString():begin_hour.toString(),begin_time=bd+" "+begin_hour+":00:00";var end_d=new Date($scope.visitorPermit.data.permit_start_date),xd=end_d.addDays(1);ed=xd.yyyymmdd(),end_hour=2+offset,end_hour=10>end_hour?"0"+end_hour.toString():end_hour.toString(),expire_time=ed+" "+end_hour+":00:00",console.log(bd+" "+ed)}else if("overnight_permit"==$scope.visitorPermit.data.permit_type){d=new Date,bd=d.yyyymmdd(),console.log("bd:"+bd),bd=convertDate($scope.visitorPermit.data.permit_start_date),begin_hour=7+offset,begin_hour=10>begin_hour?"0"+begin_hour.toString():begin_hour.toString(),begin_time=bd+" "+begin_hour+":00:00";var end_dd=new Date($scope.visitorPermit.data.permit_start_date),cd=end_dd.addDays(1);ed=cd.yyyymmdd(),end_hour=11+offset,end_hour=10>end_hour?"0"+end_hour.toString():end_hour.toString(),expire_time=ed+" "+end_hour+":00:00"}else if("three_permit"==$scope.visitorPermit.data.permit_type){d=new Date,bd=d.yyyymmdd(),bd=convertDate($scope.visitorPermit.data.permit_start_date),begin_hour=7+offset,begin_hour=10>begin_hour?"0"+begin_hour.toString():begin_hour.toString(),begin_time=bd+" "+begin_hour+":00:00";var end_ddd=new Date($scope.visitorPermit.data.permit_start_date),xxd=end_ddd.addDays(3);ed=xxd.yyyymmdd(),end_hour=11+offset,end_hour=10>end_hour?"0"+end_hour.toString():end_hour.toString(),expire_time=ed+" "+end_hour+":00:00",console.log(begin_time+" "+expire_time)}else d=new Date,bd=d.yyyymmdd(),begin_time=bd+" 00:00:00",d.addDays(14),ed=d.yyyymmdd(),expire_time=ed+" 23:59:00",console.log(bd+" "+ed);var data={creator_uid:$scope.user.uid,company_id:"t37rjido2qcxpnihkb3w",property_id:"jtyhp3dwgs3j6v8cl2zl",lot_id:"b06memz7ms39wo2tnyl5",suite_number:$scope.visitorPermit.data.vistor_suite,first_name:$scope.visitorPermit.data.first_name,last_name:$scope.visitorPermit.data.last_name,phone:$scope.visitorPermit.data.phone,email:$scope.visitorPermit.data.email,license_number:$scope.visitorPermit.data.vehicle_license,car_make:$scope.visitorPermit.data.vehicle_make,car_model:$scope.visitorPermit.data.vehicle_model,car_color:$scope.visitorPermit.data.vehicle_color,begin_time:begin_time,expire_time:expire_time,role:"visitor",permit_class:"Visitor"};console.log(data),$http({method:"POST",url:"https://"+appConfig.domain+"/permit",data:data,headers:{"Content-Type":"application/json",Authorization:"Basic "+$rootScope.user.basicAuth}}).success(function(data,status){console.log(data),notifications.showSuccess({message:"Visitor Permit Created Successfully.",hideDelay:2e3,hide:!0}),$location.path("/current-permits")}).error(function(data,status,headers,config){console.log(data)})}).error(function(data,status,headers,config){console.log(data)})};var convertDate=function(usDate){var dateParts=usDate.split(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);return dateParts[3]+"-"+dateParts[1]+"-"+dateParts[2]};$("#datepicker").datepicker({setDate:new Date,onSelect:function(dateText){console.log(dateText+" "+this.value);var datestr=dateText,start=new Date(datestr.split("/").join("-")).getTime();console.log(start),$scope.$apply(function(){$scope.visitorPermit.data.permit_start_date=dateText}),permit_custom_enable()}}),$("#datepicker2").datepicker({onSelect:function(dateText){console.log(dateText+" "+this.value);var end=convertDate(dateText);console.log(end),$scope.$apply(function(){$scope.visitorPermit.data.permit_end_date=dateText}),permit_custom_enable()}}),$("#timepicker").timepicker(),$("#timepicker").on("changeTime",function(){$scope.$apply(function(){$scope.visitorPermit.data.permit_start_time=$("#timepicker").val()})}),$("#timepicker2").timepicker(),$("#timepicker2").on("changeTime",function(){$scope.$apply(function(){$scope.visitorPermit.data.permit_end_time=$("#timepicker2").val()})})}),app.controller("welcomeController",function($scope,$rootScope,$location){$scope.welcome=function(){$location.path("/start")}});